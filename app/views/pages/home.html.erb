<%= content_for(:title) do %>
  Home
<% end %>

<%= content_for(:description) do %>
  <%# TODO %>
<% end %>



<div class="help"></div>
<div class="navbar"><h1 class='head-title'>MAP HELPER</h1></div>
<div class="wrapper">
    <div class="content-form">

      <div id="map" style="position: absolute; top: 0; bottom: 50%; left: 0; right: 0; "></div>
         <!--<%= form_for Location.new(), url: locations_path, method: :post do |f| %>
    <%= f.label "Titre de la mission" %>
    <%= f.text_field :name %>
    <%= f.label "Ville" %>
    <%= f.text_field :address, id: 'user_input_autocomplete_address' %>
    <input id="street_number" name="street_number" type="hidden" disabled>
    <input id="route" name="route" type="hidden" disabled>
    <input id="locality" name="locality" type="hidden"disabled>
    <input id="country" name="country" type="hidden" disabled>
    <%= f.label "Description" %>
    <%= f.text_area :description, class: "text optional form-control", as: :text %>
    <%= f.submit "CrÃ©er", class:'btn-form' %>
  <% end %>-->
    </div>

    <div class="content-result">
      <h2 style="text-align: center"></h2>
      <div class="code">
        <xmp>
        <div style="padding: 20px">
          <style type="text/css">
              html, body, #map-canvas {
                  height: 100%;
                  margin: 0;
                  padding: 0;
              }
          </style>
          <script type="text/javascript" src="https://maps.googleapis.com/maps/api/js">
          </script>
          <script type="text/javascript">
            function initialize() {
              var mapStyle = [{
                  stylers: [{
                      visibility: "off"
                  }]
              }, {
                  featureType: "water",
                  stylers: [{
                      visibility: "on"
                  }, {
                      color: "#f88b34"
                  }]
              }, {
                  featureType: "landscape",
                  stylers: [{
                      visibility: "on"
                  }, {
                      color: "#71092f"
                  }]
              }, {
                  featureType: "administrative",
                  elementType: "geometry.stroke",
                  stylers: [{
                      visibility: "on"
                  }, {
                      color: "#f88b34"
                  }, {
                      weight: 1
                  }]
              }];

              var mapOptions = {
                  disableDefaultUI: true,
                  center: {
                      lat: -25.397,
                      lng: 131.644
                  },
                  zoom: 4

              };
              var map = new google.maps.Map(document.getElementById('map-canvas'), mapOptions);

              map.setOptions({
                  styles: mapStyle
              });

              var locations = <%= raw @markers.to_json %>

              for (i = 0; i < locations.length; i++) {
                  var marker = new google.maps.Marker({
                      position: new google.maps.LatLng(locations[i].lat, locations[i].lng),
                      map: map,
                  });

                  (function(marker, i) {
                      // add click event
                      google.maps.event.addListener(marker, 'click', function() {
                          infowindow = new google.maps.InfoWindow({
                              content: locations[i].infowindow,
                          });
                          infowindow.open(map, marker);
                      });
                  })(marker, i);
              };
            }

            google.maps.event.addDomListener(window, 'load', initialize);
          </script>
          <div id="map-canvas"></div>
        </xmp>
      </div>
    </div>
</div>

<% content_for(:after_js) do %>
  <%= javascript_tag do %>
    $(document).on('ready', function() {
    var mapStyle = [
    {
        "stylers": [
            {
                "visibility": "off"
            }
        ]
    },
    {
        "featureType": "water",
        "stylers": [
            {
                "visibility": "on"
            },
            {
                "color": "#197fb3"
            }
        ]
    },
    {
        "featureType": "landscape",
        "stylers": [
            {
                "visibility": "on"
            },
            {
                "color": "#e3dede"
            }
        ]
    },
    {
        "featureType": "administrative",
        "elementType": "geometry.stroke",
        "stylers": [
            {
                "visibility": "on"
            },
            {
                "color": "#156993"
            },
            {
                "weight": 1
            }
        ]
    }
];

      function createSidebarLi(json){
        return ("<li><a>" + json.marker_title + "</a></li>");
      };

      function bindLiToMarker($li, marker){
        $li.on('click', function(){
          handler.getMap().setZoom(14);
          marker.setMap(handler.getMap());
          marker.panTo();
          google.maps.event.trigger(marker.getServiceObject(), 'click');
        })
      };

      function createSidebar(json_array){
        _.each(json_array, function(json){
          var $li = $( createSidebarLi(json) );
          $li.appendTo('#sidebar_container');
          bindLiToMarker($li, json.marker);
        });
      };

      var handler = Gmaps.build('Google');
      handler.buildMap({ internal: {id: 'map'}, provider: {  center: new google.maps.LatLng(-33, -33),  zoom: 2, disableDefaultUI: true, styles: mapStyle }}, function(){
        var json_array = <%= raw @markers.to_json %>;
        var markers = handler.addMarkers(json_array);
        _.each(json_array, function(json, index){
          json.marker = markers[index];
        });

        createSidebar(json_array);
        handler.bounds.extendWith(markers);
        handler.fitMapToBounds();
      });
    })
  <% end %>
<% end %>

<% content_for(:after_js) do %>
  <%= javascript_tag do %>
    $(document).on('ready', function() {
      google.maps.event.addDomListener(window, 'load', function() {
        initializeAutocomplete('user_input_autocomplete_address');
      });
    });
  <% end %>
<% end %>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.3/jquery-ui.min.js"></script>
